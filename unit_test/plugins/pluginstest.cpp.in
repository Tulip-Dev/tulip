//#include <cppunit/ui/qt/TestRunner.h>
#include <dirent.h>
#include <sys/stat.h>
#include <string.h>
#include <stdlib.h>
#include <iostream>
#include <cppunit/ui/text/TestRunner.h>
#include <cppunit/extensions/TestFactoryRegistry.h>
#include <tulip/TlpTools.h>
#ifndef NDEBUG
#include <tulip/PluginLoaderTxt.h>
#endif

int main( int argc, char** argv ) {
#if defined(_GLIBCXX_HAVE_SETENV)
  std::string tlpdir("@prefix@");
  // check for lib64
  std::string tlpdir64 = tlpdir + "/lib64/tlp";
  struct stat statInfo;
  if (stat(tlpdir64.c_str(), &statInfo) == 0)
    tlpdir += "/lib64";
  else
    tlpdir += "/lib";
  setenv("TLP_DIR", tlpdir.c_str(), 1);
#else
  if (!getenv("TLP_DIR") && !getenv("TLP_PLUGINS_PATH")) {
    std::cerr << "Error: one of TLP_DIR or TLP_PLUGINS_PATH envt variables needs to be defined" << std::endl;
    return EXIT_FAILURE;
  }
#endif
  tlp::initTulipLib();
  tlp::PluginLoader* pLoader = NULL;
#ifndef NDEBUG
  tlp::PluginLoaderTxt loader;
  pLoader = &loader;
#endif
  tlp::loadPlugins(pLoader);   // library side plugins  

  //CPPUNIT_NS::QtUi::TestRunner runner;
  CPPUNIT_NS::TextUi::TestRunner runner;
  runner.addTest( CPPUNIT_NS::TestFactoryRegistry::getRegistry().makeTest() );
  runner.run( );
  return EXIT_SUCCESS;
}
